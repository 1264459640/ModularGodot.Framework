# PerformanceMonitor 测试用例文档

## 1. 测试概述

本文档旨在为 `PerformanceMonitor` 类提供全面的测试用例，确保其在各种场景下都能正确监控和记录性能指标。测试将覆盖指标记录、计数器操作、计时器管理以及资源释放等功能。

## 2. 测试环境

- .NET 6.0
- xUnit
- FluentAssertions
- Moq（用于模拟依赖）

## 3. 测试用例

### 3.1 初始化测试

- **用例名称**: 初始化 `PerformanceMonitor`
- **测试目的**: 验证 `PerformanceMonitor` 实例能否正确初始化。
- **前置条件**: 提供有效的 `IGameLogger` 实例
- **测试步骤**:
  1. 创建 `PerformanceMonitor` 实例。
  2. 验证初始状态。
- **预期结果**: 实例创建成功，内部集合为空状态。

### 3.2 记录性能指标测试

- **用例名称**: 记录性能指标
- **测试目的**: 验证 `RecordMetric` 方法能否正确记录性能指标。
- **前置条件**: `PerformanceMonitor` 实例已创建。
- **测试步骤**:
  1. 调用 `RecordMetric` 方法记录指标。
  2. 验证指标是否被正确存储。
- **预期结果**: 性能指标被正确记录和存储。

### 3.3 记录带标签的指标测试

- **用例名称**: 记录带标签的性能指标
- **测试目的**: 验证能否正确记录带有标签的性能指标。
- **前置条件**: `PerformanceMonitor` 实例已创建。
- **测试步骤**:
  1. 使用标签调用 `RecordMetric` 方法。
  2. 验证标签信息是否被正确处理。
- **预期结果**: 带标签的指标被正确记录，标签信息被保留。

### 3.4 记录计数器测试

- **用例名称**: 记录计数器
- **测试目的**: 验证 `RecordCounter` 方法能否正确记录计数器。
- **前置条件**: `PerformanceMonitor` 实例已创建。
- **测试步骤**:
  1. 调用 `RecordCounter` 方法记录计数器。
  2. 验证计数器值是否被正确累加。
- **预期结果**: 计数器值被正确记录和累加。

### 3.5 计数器默认值测试

- **用例名称**: 计数器默认值
- **测试目的**: 验证计数器的默认值处理。
- **前置条件**: `PerformanceMonitor` 实例已创建。
- **测试步骤**:
  1. 不提供计数值调用 `RecordCounter` 方法。
- **预期结果**: 计数器使用默认值1进行累加。

### 3.6 记录计时器测试

- **用例名称**: 记录计时器
- **测试目的**: 验证 `RecordTimer` 方法能否正确记录计时器。
- **前置条件**: `PerformanceMonitor` 实例已创建。
- **测试步骤**:
  1. 调用 `RecordTimer` 方法记录时间跨度。
  2. 验证计时器数据是否被正确存储。
- **预期结果**: 计时器数据被正确记录和存储。

### 3.7 启动计时器测试

- **用例名称**: 启动计时器
- **测试目的**: 验证 `StartTimer` 方法能否正确启动计时器。
- **前置条件**: `PerformanceMonitor` 实例已创建。
- **测试步骤**:
  1. 调用 `StartTimer` 方法启动计时器。
  2. 验证返回的计时器句柄。
- **预期结果**: 返回有效的 `IDisposable` 计时器句柄。

### 3.8 计时器自动完成测试

- **用例名称**: 计时器自动完成
- **测试目的**: 验证计时器在释放时能否自动完成计时。
- **前置条件**: 已启动的计时器。
- **测试步骤**:
  1. 启动计时器。
  2. 执行一些操作。
  3. 释放计时器句柄。
- **预期结果**: 计时器自动完成，时间被记录到性能监控中。

### 3.9 带标签的计时器测试

- **用例名称**: 带标签的计时器
- **测试目的**: 验证能否正确处理带标签的计时器。
- **前置条件**: `PerformanceMonitor` 实例已创建。
- **测试步骤**:
  1. 使用标签启动计时器。
  2. 完成计时并验证结果。
- **预期结果**: 带标签的计时器被正确处理，标签信息被保留。

### 3.10 异步操作计时测试

- **用例名称**: 异步操作计时
- **测试目的**: 验证计时器在异步操作中的使用。
- **前置条件**: `PerformanceMonitor` 实例已创建。
- **测试步骤**:
  1. 在异步方法中使用计时器。
  2. 验证计时结果。
- **预期结果**: 异步操作的执行时间被正确记录。

### 3.11 创建监控键测试

- **用例名称**: 创建监控键
- **测试目的**: 验证监控键的创建逻辑。
- **前置条件**: `PerformanceMonitor` 实例已创建。
- **测试步骤**:
  1. 使用不同的名称和标签创建监控键。
  2. 验证键的格式。
- **预期结果**: 监控键按照预期格式创建。

### 3.12 参数验证测试

- **用例名称**: 参数验证
- **测试目的**: 验证各方法的参数验证逻辑。
- **前置条件**: `PerformanceMonitor` 实例已创建。
- **测试步骤**:
  1. 使用无效参数调用各种方法。
- **预期结果**: 适当的异常被抛出（如 `ArgumentNullException`）。

### 3.13 多个指标累积测试

- **用例名称**: 多个指标累积
- **测试目的**: 验证同名指标的累积处理。
- **前置条件**: `PerformanceMonitor` 实例已创建。
- **测试步骤**:
  1. 多次记录同名的指标、计数器和计时器。
  2. 验证累积结果。
- **预期结果**: 同名指标被正确累积，统计信息准确。

### 3.14 并发操作测试

- **用例名称**: 并发操作
- **测试目的**: 验证性能监控在并发环境下的线程安全性。
- **前置条件**: 多个线程同时访问性能监控。
- **测试步骤**:
  1. 创建多个线程同时进行性能监控操作。
  2. 验证操作结果的正确性。
- **预期结果**: 所有操作都能正确执行，数据一致性得到保证。

### 3.15 资源释放测试

- **用例名称**: 释放性能监控资源
- **测试目的**: 验证 `Dispose` 方法能否正确释放资源。
- **前置条件**: `PerformanceMonitor` 实例已创建，可能有活跃的计时器。
- **测试步骤**:
  1. 启动一些计时器。
  2. 调用 `Dispose` 方法释放资源。
  3. 验证资源释放状态。
- **预期结果**: 所有资源被正确释放，活跃计时器被完成，集合被清空。

### 3.16 释放后操作测试

- **用例名称**: 释放后操作处理
- **测试目的**: 验证资源释放后的操作处理。
- **前置条件**: `PerformanceMonitor` 已被释放。
- **测试步骤**:
  1. 尝试进行各种性能监控操作。
- **预期结果**: 记录操作被忽略，启动计时器抛出 `ObjectDisposedException`。

### 3.17 边界条件测试

- **用例名称**: 边界条件处理
- **测试目的**: 验证各种边界条件的处理。
- **前置条件**: `PerformanceMonitor` 实例已创建。
- **测试步骤**:
  1. 测试极大和极小的数值。
  2. 测试空字符串和特殊字符。
  3. 测试空标签字典。
- **预期结果**: 边界条件被正确处理，不会导致异常。

### 3.18 内存使用测试

- **用例名称**: 内存使用优化
- **测试目的**: 验证性能监控的内存使用效率。
- **前置条件**: `PerformanceMonitor` 实例已创建。
- **测试步骤**:
  1. 记录大量性能数据。
  2. 监控内存使用情况。
- **预期结果**: 内存使用保持在合理范围内，无内存泄漏。

## 4. 测试覆盖率

- 功能测试: 100%
- 边界测试: 95% (包括各种边界值和异常输入)
- 异常测试: 90% (包括并发访问、资源释放等异常情况)

## 5. 结论

通过以上测试用例的执行，可以确保 `PerformanceMonitor` 的功能正确性、性能和稳定性。建议定期执行这些测试以确保性能监控功能的可靠性和准确性。