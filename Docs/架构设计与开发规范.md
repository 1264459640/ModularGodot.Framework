# 架构设计与开发规范

本文档用于规范本仓库中基于 MediatR 的 CQRS 架构、设计原则与开发实现，确保“指令由服务（业务能力）提供，节点仅作为发起方”，并在不改变现有依赖边界的前提下，提升可维护性与可扩展性。

## 1. 适用范围与约束
- **适用范围**：MF.CQRS 目录下的所有 MediatR `Request`（包括 Commands 和 Queries）、Handlers 和 Results。
- **约束前提**：
  - 不改变当前项目依赖边界与分布。
  - 表示层（Godot Node）仅构造并发送命令，不接触处理器实现。
  - 处理器仅依赖服务接口，不直接依赖 Godot API。

## 2. 分层与依赖方向

### 2.1 简化的三层架构
- **表示层（Godot Nodes）**：负责输入收集、命令/查询发送、结果展示。
- **应用层（MF.CQRS）**：包含 Commands、Queries、Handlers 和 Results，承担业务逻辑。
- **仓储/基础设施层（MF.Repositories/Infrastructure）**：负责数据访问和基础设施服务。

### 2.2 依赖方向
```
UI(Node) → MediatR(IRequest) → Handler → Repository/Infrastructure
```

### 2.3 职责分离
- **Command Handler**：处理写操作，包含业务逻辑验证和执行。
- **Query Handler**：处理读操作，可直接访问仓储进行数据读取。
- **仓储层**：专注数据访问，不包含业务逻辑。

## 3. 契约设计（Commands/Queries/Results）
- **纯数据**：仅使用基础类型、字符串、枚举、轻量 DTO；禁止出现 Godot 类型或 Node 引用。
- **不可变**：优先使用 `record`，构造完成即完整。
- **可追踪**：预留或支持注入 `CorrelationId` 以串联日志与指标。
- **可演进**：新增字段需具备默认值与后向兼容。
- **统一结果**：提供 `Success/Failed` 工厂、错误码与消息；承载关键诊断信息（耗时、统计等）。

## 4. 处理器设计（Handlers）
- **单一职责**：一个处理器只处理一个命令或查询。
- **依赖策略**：
  - **Command Handler**：可依赖仓储接口和基础设施服务，在 Handler 内实现业务逻辑。
  - **Query Handler**：可直接访问仓储接口进行数据读取，专注性能优化。
  - **共同约束**：禁止直接访问 Godot API，使用抽象接口。
- **可取消**：必须接收 `CancellationToken` 并在关键节点检查。
- **输入验证**：对参数进行校验，失败时返回失败结果而非抛异常。
- **错误边界**：预期错误返回失败结果；非预期异常则捕获、记录并转译。
- **日志**：在入口/出口与关键阶段输出结构化日志。
- **性能**：I/O 异步化；并发有上限；必要时产出聚合诊断指标。

## 5. 命名、组织与动词指南

### 5.1 总体原则
- **面向业务意图**命名，避免技术性或含糊不清的名称。
- 通过统一**后缀**清晰地区分不同类型：`Command`/`Query`/`Request`/`Handler`/`Result`/`Response`。
- 应用层不直接依赖 Godot 的具体类型（`Node`/`Resource` 等），使用接口与 DTO 传递数据。

### 5.2 类与消息命名规范

#### Command（写操作）
- **格式**：`{动词}{名词}Command`
- **返回类型**：`{动词}{名词}Result`
- **示例**：`StartResourceStressTestCommand` → `StartResourceStressTestResult`

#### Query（读操作）
- **格式**：`{Get/List/Find...}{名词}Query`
- **返回类型**：简单查询直接返回数据；复杂查询返回 `{...}QueryResult`。
- **示例**：`LoadResourceQuery` → `LoadResourceQueryResult`

#### Request（通用请求）
- **格式**: `{动词}{名词}Request`
- **返回类型**: `{...}Response`
- **用途**: 用于不严格属于“写”或“纯读”的场景，如执行一个需要返回特定响应体的计算。
- **示例**: `CalculatePathRequest` → `CalculatePathResponse`

#### Handler
- **格式**：与消息一一对应，`{消息名}Handler`。
- **示例**：`RunResourceStressTestCommandHandler`。

### 5.3 命名空间与目录结构
建议在 `MF.CQRS` 下按“功能领域/用例”组织文件（Feature-first）：
```
MF.CQRS/
└── ResourceManagement/          # 功能领域
    ├── LoadResource/            # 用例
    │   ├── LoadResourceQuery.cs
    │   ├── LoadResourceQueryHandler.cs
    │   └── LoadResourceResult.cs
    └── StressTesting/
        ├── RunResourceStressTestCommand.cs
        ├── RunResourceStressTestCommandHandler.cs
        └── RunResourceStressTestResult.cs
```
- **命名空间**应与目录对应：`ModularGodot.Framework.CQRS.ResourceManagement.LoadResource`。

### 5.4 动词选择指南
- **幂等写**：`Set`, `Assign`, `Upsert`, `Enable`, `Disable`
- **非幂等写**：`Create`, `Start`, `Stop`, `Delete`, `Increment`
- **读取**：`Get`, `List`, `Find`, `Count`, `Export`
- **编排/批处理**：`Run`, `Execute`, `Schedule`

## 6. 其他设计原则

- **取消与超时**：UI 必须传递 `CancellationToken`；处理器在密集循环/等待处检查取消。
- **错误处理**：失败结果需包含错误码、用户可理解的消息和诊断字段。禁止泄露敏感信息。
- **日志与遥测**：统一使用 `IGameLogger`；通过 `CorrelationId` 串联请求链路。
- **Godot 约束**：处理器严禁访问 `Node`/`Scene` 等主线程对象。UI 更新通过消费结果数据自行渲染。
- **版本化**：新增字段遵循“可选、可默认”的加法原则。弃用时使用 `[Obsolete]` 标注。
- **安全**：对输入参数进行清理和校验；命令执行不得突破资源根目录范围。
- **测试**：以处理器为单位进行单元测试，用桩替换服务接口。

## 7. 实现与重构示例

### 7.1 实现建议
- **资源加载（Query 模式）**: `LoadResourceQuery/Handler` 用于资源读取，Handler 可直接访问仓储接口。
- **资源压力测试（Command 模式）**: `RunResourceStressTestCommand/Handler` 在 Handler 内实现测试业务逻辑。
- **UI 层约束**: 节点仅构造命令/查询并展示结果，传递 `CancellationToken`。

### 7.2 重构示例：资源加载
- **重构前**: `LoadResourceRequest` → `LoadResourceResponse`
- **重构后**: `LoadResourceQuery` → `LoadResourceResult`
- **目录结构**:
  ```
  MF.CQRS/ResourceManagement/LoadResource/
  ├── LoadResourceQuery.cs
  ├── LoadResourceResult.cs
  └── ResourceType.cs
  ```

## 8. 推进与检查清单

### 8.1 推进清单
1. **架构迁移**：将现有的 `Request/Response` 迁移为 `Query/Result` 模式。
2. **Handler 重构**：让 Command Handler 承担业务逻辑，Query Handler 专注数据读取。
3. **依赖调整**：Handler 直接依赖仓储接口。
4. **补充元数据**：为所有命令/查询补充 `CorrelationId`、默认值与注释。
5. **完善处理**：为处理器补充日志、取消检查、错误码分支。
6. **建立规范**：建立统一的错误码清单。
7. **测试覆盖**：为每个命令/查询编写单元测试。

### 8.2 提交前检查清单
- [ ] 写操作是否以 `...Command` 结尾？
- [ ] 读操作是否使用 `...Query`，且不包含副作用？
- [ ] Handler 是否与消息一一对应，命名为 `...Handler`？
- [ ] 返回类型是否使用 `...Result` 或 `...Response` 后缀？
- [ ] 是否按“功能领域/用例”组织目录？
- [ ] 应用层是否避免了 Godot 引擎类型的直接依赖？

— 完 —